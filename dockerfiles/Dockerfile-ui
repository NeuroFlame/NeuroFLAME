FROM neuroflame/ci
ARG DOCKER_GID

RUN apt-get update && \
    apt-get install -y xvfb \
    x11-apps \
    ffmpeg \
    imagemagick \
    libgbm1 \
    libxss1 \
    libnss3 \
    libgtk-3-dev \
    libasound2-dev \
    unzip \
    && rm -rf /var/lib/apt/lists/* \
    && mkdir -p /tmp/screencap/

WORKDIR /nf/desktopApp/electronApp

RUN useradd --create-home --shell /bin/bash electronuser
RUN chown -R electronuser:electronuser /nf
USER electronuser

  CMD bash -c '\
  xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" bash -c "\
    ffmpeg -y -video_size 1280x960 -framerate 25 -f x11grab -i \$DISPLAY \
      -c:v libx264 -preset ultrafast -pix_fmt yuv420p \
      /tmp/screencap/output.mp4 > /tmp/screencap/ffmpeg.log 2>&1 & \
    FFMPEG_PID=\$! && \
    npm run test; \
    UI_EXIT=\$?; \
    kill -INT \$FFMPEG_PID; \
    wait \$FFMPEG_PID; \
    exit \$UI_EXIT"'
