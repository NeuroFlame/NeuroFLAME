FROM neuroflame/ci
ARG DOCKER_GID
ARG HOST_UID
ARG HOST_GID

RUN apt-get update && \
    apt-get install -y xvfb \
    x11-apps \
    ffmpeg \
    imagemagick \
    libgbm1 \
    libxss1 \
    libnss3 \
    libgtk-3-dev \
    libasound2-dev \
    unzip \
    && rm -rf /var/lib/apt/lists/* \
    && mkdir -p /tmp/screencap/

WORKDIR /nf/desktopApp/electronApp

# Remove existing user/group if they conflict (safe for rebuilds)
RUN if getent group $HOST_GID >/dev/null; then \
      existing_group=$(getent group $HOST_GID | cut -d: -f1); \
      echo "Deleting existing group $existing_group with GID $HOST_GID"; \
      groupdel "$existing_group"; \
    fi && \
    if getent passwd $HOST_UID >/dev/null; then \
      existing_user=$(getent passwd $HOST_UID | cut -d: -f1); \
      echo "Deleting existing user $existing_user with UID $HOST_UID"; \
      userdel -r "$existing_user" || true; \
    fi && \
    groupadd -g $HOST_GID electronuser && \
    useradd --create-home --shell /bin/bash -u $HOST_UID -g $HOST_GID electronuser

RUN chown -R electronuser:electronuser /nf
USER electronuser

CMD ["/bin/bash", "-c", "\
  echo '== Container UID/GID =='; id; \
  echo '== screencap permissions =='; ls -ld /tmp/screencap || echo 'Missing /tmp/screencap'; \
  echo '== trying to write =='; touch /tmp/screencap/testfile && echo '✅ Success' || echo '❌ Failed'; \
  sleep 3600 \
"]
  # CMD bash -c '\
  # xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" bash -c "\
  #   ffmpeg -y -video_size 1280x960 -framerate 25 -f x11grab -i \$DISPLAY \
  #     -c:v libx264 -preset ultrafast -pix_fmt yuv420p \
  #     /tmp/screencap/output.mp4 > /tmp/screencap/ffmpeg.log 2>&1 & \
  #   FFMPEG_PID=\$! && \
  #   npm run test; \
  #   UI_EXIT=\$?; \
  #   kill -INT \$FFMPEG_PID; \
  #   wait \$FFMPEG_PID; \
  #   exit \$UI_EXIT"'
